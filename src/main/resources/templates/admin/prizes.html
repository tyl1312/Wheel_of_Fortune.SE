<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Prize Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Prize Management</h1>
        
        <!-- Navigation -->
        <nav class="mb-4">
            <a href="/admin/dashboard" class="btn btn-outline-primary me-2">Dashboard</a>
            <a href="/admin/users" class="btn btn-outline-primary me-2">Users</a>
            <a href="/admin/missions" class="btn btn-outline-primary me-2">Missions</a>
            <a href="/admin/prizes" class="btn btn-primary me-2">Prizes</a>
        </nav>

        <!-- Prizes Table -->
        <div class="card">
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Prize Description</th>
                            <th>Probability (%)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="prize : ${prizes}">
                            <td th:text="${prize.prizeId}">1</td>
                            <td th:text="${prize.prizeDescription}">Free Item</td>
                            <td>
                                <input type="number" class="form-control probability-input" 
                                       th:value="${prize.probability}" 
                                       th:data-prize-id="${prize.prizeId}"
                                       step="0.1" min="0" max="100" style="width: 100px;">
                            </td>
                            <td>
                                <button class="btn btn-sm btn-success update-probability-btn" 
                                        th:data-prize-id="${prize.prizeId}">
                                    Update
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Show total probability -->
                <div class="mt-3">
                    <strong>Total Probability: <span id="totalProbability">--</span>%</strong>
                    <small class="text-muted d-block">Should equal 100% for fair distribution</small>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Calculate and display total probability
        function updateTotalProbability() {
            let total = 0;
            document.querySelectorAll('.probability-input').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            document.getElementById('totalProbability').textContent = total.toFixed(1);
            
            // Change color based on whether it equals 100
            const totalElement = document.getElementById('totalProbability');
            if (Math.abs(total - 100) < 0.1) {
                totalElement.style.color = 'green';
            } else {
                totalElement.style.color = 'red';
            }
        }

        // Update total when any input changes
        document.querySelectorAll('.probability-input').forEach(input => {
            input.addEventListener('input', updateTotalProbability);
        });

        // Initial calculation
        updateTotalProbability();

        // Update prize probability
        document.querySelectorAll('.update-probability-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const prizeId = this.dataset.prizeId;
                const probabilityInput = document.querySelector(`input[data-prize-id="${prizeId}"]`);
                const probability = probabilityInput.value;

                fetch(`/admin/prizes/${prizeId}/update-probability`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `probability=${probability}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Probability updated successfully!');
                        updateTotalProbability();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
            });
        });
    </script>
</body>
</html>